'use strict';class ApiHandler{call(a,b,c,d){const e=new Headers;return e.set('Accept','application/json'),e.set('Content-Type','application/json; charset=utf-8'),fetch(a,{method:c?'POST':'GET',headers:e,body:c?JSON.stringify(c):null}).then(a=>a.json()).then(a=>{b&&b(a,d)})}}class FormHandler{submit(a,b,c){const d=new Headers;return d.set('Accept','application/json'),fetch(a.action,{method:a.method,headers:d,body:new FormData(a)}).then(a=>a.json()).then(a=>{b&&b(a,c)})}}const CHARTS_API_BASE=location.protocol+'//'+location.hostname+'/api/charts/';function updateGraphs(){const a={year:document.getElementById('graph_year').value,month:document.getElementById('graph_month').value,day:document.getElementById('graph_day').value};updateGraphUsersCount(a)}function updateGraphUsersCount(a){var b='month';'%'==a.day?'%'!=a.month&&(b='day'):b='hour';const c={graph_area_id:'graph-user-count',titles:['Users'],time_order:b};new ApiHandler().call(CHARTS_API_BASE+'user-count',a,plotLineChart,c)}function plotLineChart(a,b){var c=Math.ceil,d=jQuery('#'+b.graph_area_id);if(!a.length)return void(d[0].innerHTML='<p><mark>No data.</mark></p>');const e=[.7,.5];var f,g,h,k=1,l=12,m=0;for('hour'==b.time_order?(k=0,l=24):'day'==b.time_order&&(l=31),1==b.titles.length&&(a=[a]),g=0;g<b.titles.length;g++){for(h=0,f=0;f<a[g].length;f++)h+=a[g][f].value,a[g][f].value>m&&(m=a[g][f].value),a[g][f]=[a[g][f][b.time_order],a[g][f].value];a[g]={label:b.titles[g].trim()+' ('+h+')',data:a[g],lines:{show:!0,fill:!0,fillColor:{colors:[{opacity:e[g]},{opacity:e[g]}]}},points:{show:!0,radius:4}}}$.plot(d,a,{xaxis:{min:k,max:l,tickSize:1,tickDecimals:0},yaxis:{min:0,max:c(1.1*m),tickSize:c(m/10),tickDecimals:0},colors:['#abe37d','#faad7d'],grid:{borderWidth:1,hoverable:!0}}),createTooltips(d)}function plotBarChart(a,b){var c=Math.ceil,d=jQuery('#'+b.graph_area_id);if(!a.length)return void(d[0].innerHTML='<p><mark>No data.</mark></p>');var e,f=0,g=labels=[];for(e=0;e<a.length;e++)g[g.length]={label:a[e].label+' ('+a[e].value+')',data:[[e,a[e].value]],bars:{show:!0,barWidth:a.length/4,lineWidth:0,align:'center',fillColor:{colors:[{opacity:.7},{opacity:.7}]}}},labels[labels.length]=[e,a[e].label],a[e].value>f&&(f=a[e].value);jQuery.plot(d,g,{legend:{show:!0},grid:{borderWidth:1,hoverable:!0},yaxis:{min:0,max:c(1.1*f),tickSize:c(f/10),tickDecimals:0,tickColor:'#f5f5f5'},xaxis:{ticks:labels,tickColor:'#f5f5f5'}}),createTooltips(d)}function plotPieChart(a,b){var c=jQuery('#'+b.graph_area_id);return a.length?void $.plot(c,a,{legend:{show:!0},series:{pie:{show:!0,radius:1,label:{show:!0,radius:2/3,formatter:(a,b)=>'<div class="flot-pie-label">'+a+'<br>'+Math.round(b.percent)+'%</div>',background:{opacity:.7,color:'#000000'}}}}}):void(c[0].innerHTML='<p><mark>No data.</mark></p>')}function createTooltips(a){a.bind('plothover',(a,b,c)=>{if(jQuery('.js-flot-tooltip').remove(),!!c){const a='<strong>'+c.datapoint[1]+'</strong>';jQuery('<div class="js-flot-tooltip flot-tooltip" align="center">'+a+'</div>').css({top:c.pageY-45,left:c.pageX+5}).appendTo('body').show()}})}const PREVIEW_LENGTH=45,TYPE_SECTION='SECTION',TYPE_SENTENCE='SENTENCE',TYPE_DOCUMENT='DOCUMENT',TYPE_IMAGE='IMAGE';var data=[{text:'Click to add title',type:'document',data:{database:{id:'-1',type:'DOCUMENT',document_title:'Click to add title',protected:!1}},children:[]}],$tree=null;$(function(){$tree=$('#structure'),$tree.jstree({core:{animation:0,check_callback:!0,themes:{stripes:!0},data:data},types:{sentence:{icon:'/img/sentence.png',valid_children:[]},section:{icon:'/img/section.png'},imagefield:{icon:'/img/icon-image.png',valid_children:[]}},plugins:['types','dnd']}).on('loaded.jstree',function(){$tree.jstree('open_all'),document.getElementById('edit').innerHTML=''}).on('select_node.jstree',function(a,b){editNode(b.node)}).on('create_node.jstree',function(a,b){console.log('created node',a),console.log('created parent',b)})});function deleteNode(){const a=$tree.jstree().get_node($tree.jstree().get_selected());return a.data.database.type==TYPE_DOCUMENT?void alert('Can not delete document here. To delete document go to document list, select it and click delete.'):void($tree.jstree().delete_node(a),setTimeout(function(){$tree.jstree(!0).trigger('loaded.jstree')},800))}function addSentence(){const a=$tree.jstree().get_node($tree.jstree().get_selected());if('sentence'===a.type||'image'===a.type)return void alert('Can not add sentance, image or section to sentence!');$tree.jstree().create_node(a,{text:'New sentence',state:'open',type:'sentence',data:{database:{id:'-1',type:TYPE_SENTENCE,sentence_number:'',sentence_text:'New sentence'}}},'last',function(){$tree.jstree().open_node(a)})}function addSection(){const a=$tree.jstree().get_node($tree.jstree().get_selected());if('sentence'===a.type||'image'===a.type)return void alert('Can not add sentance, image or section to section!');$tree.jstree().create_node(a,{text:'New section',state:'open',type:'section',data:{database:{id:'-1',type:TYPE_SECTION,section_number:'',section_title:'New section',section_description:'New section description'}}},'last',function(){$tree.jstree().open_node(a)})}function addImage(){const a=$tree.jstree().get_node($tree.jstree().get_selected());if('sentence'===a.type||'image'===a.type)return void alert('Can not add sentance, section or image to image!');$tree.jstree().create_node(a,{text:'Image',state:'open',type:'imagefield',data:{database:{id:'-1',type:TYPE_IMAGE,image_source:'',image_description:'Image description'}}},'last',function(){$tree.jstree().open_node(a)})}function editNode(a){console.log(a),console.log('edit node pozvan');var b=document.getElementById('edit'),c=document.createElement('label'),d=document.createElement('label'),e=document.createElement('span'),f=document.createElement('span'),g=document.createElement('span');if(a.data.database.type==TYPE_SECTION){var h=document.createElement('input');g=document.createElement('input'),e=document.createElement('label'),f=document.createElement('input'),d.innerHTML='Section title',c.innerHTML='Section number',e.innerHTML='Section description',h.addEventListener('input',function(b){const c=b.target.value;a.data.database.section_title=c;let d=a.data.database.section_number+' '+a.data.database.section_title;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),g.addEventListener('input',function(b){const c=b.target.value;a.data.database.section_number=c;let d=a.data.database.section_number+' '+a.data.database.section_title;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),f.addEventListener('input',function(b){const c=b.target.value;a.data.database.section_description=c,$tree.jstree().redraw_node(a,!0)}),h.value=a.data.database.section_title,g.value=a.data.database.section_number,f.value=a.data.database.section_description}else if(a.data.database.type===TYPE_SENTENCE){var h=document.createElement('textarea');h.rows=10,g=document.createElement('input'),d.innerHTML='Sentence text',c.innerHTML='Sentence number',h.addEventListener('input',function(b){const c=b.target.value;a.data.database.sentence_text=c;let d=a.data.database.sentence_number+' '+a.data.database.sentence_text;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),g.addEventListener('input',function(b){const c=b.target.value;a.data.database.sentence_number=c;let d=a.data.database.sentence_number+' '+a.data.database.sentence_text;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),h.value=a.data.database.sentence_text,g.value=a.data.database.sentence_number}else if(a.data.database.type===TYPE_DOCUMENT){var h=document.createElement('input');d.innerHTML='Document title',g=document.createElement('input'),g.name='protected',g.type='checkbox',c.innerHTML='Protected',h.addEventListener('input',function(b){const c=b.target.value;a.data.database.document_title=c;let d=a.data.database.document_title;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),g.addEventListener('change',function(b){const c=b.target.checked;a.data.database.protected=c,$tree.jstree().redraw_node(a,!0)}),h.value=a.data.database.document_title,g.checked=a.data.database.protected}else if(a.data.database.type===TYPE_IMAGE){var h=document.createElement('input');h.type='file',g=document.createElement('input'),d.innerHTML='Choose image',c.innerHTML='Image description',h.addEventListener('change',function(b){const c=b.target.files[0],d=new FormData;d.append('image',c);var e=new XMLHttpRequest;e.open('POST','/api/document/image-upload',!0),e.onload=function(){if(200==e.status){const b=JSON.parse(e.responseText),c=b.image_url;a.data.database.image_source=c;const d=document.getElementById('edit');let f=d.querySelector('img');f.src=c,$tree.jstree().redraw_node(a,!0)}else console.log(e),console.log('error occured')},e.setRequestHeader('Authorization','Bearer '+userToken),e.send(d)}),g.addEventListener('input',function(b){const c=b.target.value;a.data.database.image_description=c;let d='Image - '+a.data.database.image_description;44<d.length&&(d=d.substr(0,PREVIEW_LENGTH)+' ...'),a.text=d,$tree.jstree().redraw_node(a,!0)}),g.value=a.data.database.image_description}else return;if(b.innerHTML='',b.appendChild(c),b.appendChild(g),b.appendChild(d),b.appendChild(h),b.appendChild(e),b.appendChild(f),a.data.database.type===TYPE_SENTENCE)if(-1==a.data.database.id){const a=document.createElement('span');a.innerHTML='Adding comments will be available after saving.',b.appendChild(a)}else b.appendChild(renderCommenting());if(a.data.database.type===TYPE_IMAGE){const c=document.createElement('img');c.src=a.data.database.image_source,c.style='width:100%',b.appendChild(c)}}function saveNode(){let a=$tree.jstree().get_json();a=JSON.stringify(a);var b=new XMLHttpRequest;const c=new FormData;c.append('data',a),b.onreadystatechange=function(){4==this.readyState&&200==this.status&&(fireNotification({message:'Saved',icon:'fa fa-check',type:'success',delay:5}),refreshDocument(b.responseText))},b.open('POST','/api/backend/process-document',!0),b.setRequestHeader('Authorization','Bearer '+userToken),b.send(c)}function refreshDocument(a){if(console.log('refresh pozva'),'-1'==a){return $tree.jstree(!0).settings.core.data=[{text:'Click to add title',data:{database:{id:'-1',type:'DOCUMENT',document_title:'Click to add title',protected:!1}},children:[]}],$tree.jstree(!0).refresh(),void setTimeout(function(){$tree.jstree(!0).trigger('loaded.jstree')},800)}var b=new XMLHttpRequest;const c=new FormData;c.append('data',data),b.onreadystatechange=function(){if(4==this.readyState&&200==this.status){console.log('data',b.responseText);const a=JSON.parse('[ '+b.responseText+' ]');$tree.jstree(!0).settings.core.data=a,$tree.jstree(!0).refresh(),setTimeout(function(){$tree.jstree(!0).trigger('loaded.jstree')},800)}},b.open('GET','/api/backend/documents/'+a,!0),b.setRequestHeader('Authorization','Bearer '+userToken),b.send(c)}var commentCategories=[];fetch('/comment-categories').then(a=>a.json()).then(a=>commentCategories=a);function renderCommenting(){const a=document.createElement('div'),b=document.createElement('p'),c=document.createElement('div');c.id='comments-container',b.innerHTML='Commenting',a.appendChild(b);const d=document.createElement('select'),e=document.createElement('option');e.text='-',e.value=-1,d.id='comment-category-id',d.add(e),d.onchange=a=>showComments(a.target.value),commentCategories.forEach(a=>{const b=document.createElement('option');b.text=a.name,b.value=a.id,d.add(b)});const f=addCommentRender();return a.appendChild(d),a.appendChild(f),a.appendChild(c),a}async function showComments(a){const b={headers:{Authorization:'Bearer '+userToken}},c=$tree.jstree().get_node($tree.jstree().get_selected()).data.database.id,d=await fetch('/api/sentences/'+c+'/'+a,b).then(a=>a.json()),e=document.getElementById('comments-container');e.innerHTML='',d.data.comments.forEach(a=>{const b=document.createElement('div');b.style='position:relative';const c=document.createElement('p'),d=document.createElement('p');d.style='border-bottom: 1px solid silver;',c.innerText=a.user.name+' '+(a.user.surname?a.user.surname:''),d.innerText=a.comment;const f=document.createElement('button');f.type='button',f.innerHTML='Delete',f.style='position:absolute; right:0;',f.onclick=()=>deleteComment(a.id),b.appendChild(f),b.appendChild(c),b.appendChild(d),e.appendChild(b)})}function addCommentRender(){const a=document.createElement('form'),b=document.createElement('textarea'),c=document.createElement('button');return a.onsubmit=a=>addComment(a),b.name='text',c.innerText='Comment',a.appendChild(b),a.appendChild(c),a}async function addComment(a){a.preventDefault();const b=new FormData(a.target),c=document.getElementById('comment-category-id').value;b.append('category_id',c);const d=new Headers;d.set('Accept','application/json'),d.set('Authorization','Bearer '+userToken);console.log('event',a);const e=$tree.jstree().get_node($tree.jstree().get_selected()).data.database.id,f=await fetch('/api/sentences/'+e+'/comments',{method:'post',headers:d,body:b}).then(a=>a.json());return console.log(f),showComments(c),a.target.reset(),!1}async function deleteComment(a){const b=new Headers;b.set('Accept','application/json'),b.set('Authorization','Bearer '+userToken);try{const c=await fetch('/api/comments/'+a,{method:'delete',headers:b}).then(a=>a.json()),d=document.getElementById('comment-category-id').value;showComments(d)}catch(a){alert('An error occured while deleting comment.')}}const IMAGE_FILTER=['image/jpg','image/jpeg','image/png','image/bmp','image/gif'],VIDEO_FILTER=['video/mp4','video/webm','video/ogg'];function mainInit(){blockPage(),initFonts(),initDatatables(),initDateTimeRangePickers(),fixInputColor(),initMaxlength(),addFormNotify('form-notify'),unblockPage(),displayErrors('error-messages'),lazyLoadMedia('lazy-load')}function confirmAlert(){return swal({titleText:'Are you sure?',type:'warning',showCancelButton:!0,showCloseButton:!0,buttonsStyling:!1,confirmButtonText:'<i class="la la-check"></i> Ok',confirmButtonClass:'btn m-btn btn-primary',cancelButtonText:'<i class="la la-close"></i> Cancel',cancelButtonClass:'btn m-btn btn-secondary'})}function successAlert(){return swal({titleText:'Success!',type:'success',timer:3e3,showCloseButton:!0,buttonsStyling:!1,confirmButtonText:'<i class="la la-check"></i> Ok',confirmButtonClass:'btn m-btn btn-success'})}function initMaxlength(){$('input[maxlength], textarea[maxlength]').maxlength({alwaysShow:!0,warningClass:'m-badge m-badge--primary m-badge--rounded m-badge--wide',limitReachedClass:'m-badge m-badge--danger m-badge--rounded m-badge--wide'})}function fixInputColor(){$('input[type=color]').css('height','36px')}function initFonts(){WebFont.load({google:{families:['Poppins:300,400,500,600,700','Roboto:300,400,500,600,700']},active:()=>{sessionStorage.fonts=!0}})}function initDatatables(){$('table.js-datatable').DataTable({order:[],processing:!0,colReorder:!0,pagingType:'full_numbers',pageLength:50,lengthMenu:[[10,50,100,-1],[10,50,100,'All']],dom:'<\'row\'<\'col-sm-4 text-left\'f><\'col-sm-4 text-left dataTables_pager\'lp><\'col-sm-4 text-right\'B>>\n\t\t\t<\'row\'<\'col-sm-12\'tr>>\n\t\t\t<\'row\'<\'col-sm-12 col-md-5\'i><\'col-sm-12 col-md-7 dataTables_pager\'lp>>',buttons:[{extend:'collection',text:'Export',autoClose:!0,buttons:['copyHtml5','print','csvHtml5','excelHtml5','pdfHtml5']},{extend:'collection',text:'Visibility',buttons:['colvisRestore','colvis']}]})}function showMedia(a,b){b=document.getElementById(b),b.innerHTML='';var c,d,e,f,g;for(const h of a.files){if(c=window.URL.createObjectURL(h),e=h.type,-1<IMAGE_FILTER.indexOf(e))g='<a target="_blank" href="'+c+'"><img class="img-thumbnail" src="'+c+'"></a>';else if(-1<VIDEO_FILTER.indexOf(e))g='<video controls class="img-thumbnail"><source src="'+c+'" type="'+e+'"></video>';else continue;d=h.name.trim(),f=h.size/1048576,f=parseFloat(f.toFixed(2)),b.insertAdjacentHTML('beforeend','<div class="col-sm-2">'+g+'<p>'+d+' ('+f+' MB)</p></div>')}}function lazyLoadMedia(a){const b=$('.'+a+'[data-src]');for(const c of b)c.src=c.dataset.src.trim()}function addFormNotify(a){const b=document.querySelectorAll('form.'+a);for(const c of b)c.onsubmit=()=>{fireNotification({message:'Saving data in progress...',icon:'fa fa-spinner fa-spin',type:'success',delay:0});const a=document.querySelectorAll('button[type="submit"][form="'+c.id+'"]');for(const b of a)b.disabled=!0,b.classList.add('m-loader','m-loader--light','m-loader--right')}}function blockPage(){mApp.blockPage({overlayColor:'#000000',type:'loader',state:'success',message:'Please wait...'})}function unblockPage(){mApp.unblockPage()}function blockModal(a){mApp.block('#'+a+' .modal-content',{overlayColor:'#000000',type:'loader',state:'primary'})}function unblockModal(a){mApp.unblock('#'+a+' .modal-content')}function initDateTimeRangePickers(){$('.datetimerangepicker').daterangepicker({buttonClasses:'m-btn btn',applyClass:'btn-primary',cancelClass:'btn-secondary',timePicker:!0,timePicker24Hour:!0,showWeekNumbers:!0,autoUpdateInput:!0,minDate:new Date,locale:{format:'DD/MM/YYYY HH:mm'}},function(c,a){const b=$(this).attr('element').attr('id');$('#'+b+'-first').val(c.format('YYYY-MM-DD HH:mm:ss')),$('#'+b+'-second').val(a.format('YYYY-MM-DD HH:mm:ss'))})}function fireNotification(a){return $.notify({message:a.message,icon:'icon '+a.icon},{type:a.type,delay:1e3*a.delay})}function localTimestamp(a,b='DD/MM/YYYY HH:mm'){return moment.utc(a).local().format(b)}function toggleCheckboxes(a,b){const c=document.querySelectorAll('input.'+b);for(const d of c)d.checked=a}function gatherFormInputs(a){confirmAlert().then(b=>{if(b.value){fireNotification({message:'Saving data in progress...',icon:'fa fa-spinner fa-spin',type:'success',delay:0});const b=document.querySelectorAll('input.options-form:checked');for(const c of b)c.setAttribute('form',a.id);a.submit()}})}function displayErrors(a){const b=JSON.parse(document.getElementById(a).innerHTML.trim());for(const c of b)fireNotification({message:c,icon:'fa fa-exclamation-triangle',type:'danger',delay:5})}const DEFAULT_LAT=-44.3833623,DEFAULT_LNG=171.2402853;var marker,map=null;function mapResize(){if(map){var a=!0;const d=document.getElementById('map_name').value.trim();var b=document.getElementById('map_latitude').value,c=document.getElementById('map_longitude').value;(''==b||''==c)&&(b=DEFAULT_LAT,c=DEFAULT_LNG,a=!1),b=parseFloat(b),c=parseFloat(c),google.maps.event.trigger(map,'resize'),map.setCenter({lat:b,lng:c}),a&&pinOnMap(marker,d,b,c)}}function initMap(){map=new google.maps.Map(document.getElementById('map_container'),{center:{lat:DEFAULT_LAT,lng:DEFAULT_LNG},zoom:13}),marker=new google.maps.Marker({map:map,position:null,draggable:!0}),map.addListener('click',function(a){const b=document.getElementById('map_name').value.trim();pinOnMap(marker,b,a.latLng.lat(),a.latLng.lng())}),map.addListener('rightclick',function(a){const b=document.getElementById('map_name').value.trim();pinOnMap(marker,b,a.latLng.lat(),a.latLng.lng())}),marker.addListener('position_changed',function(){const a=marker.getPosition();document.getElementById('map_latitude').value=a.lat(),document.getElementById('map_longitude').value=a.lng()})}function pinOnMap(a,b,c,d){const e=new google.maps.LatLng({lat:parseFloat(c),lng:parseFloat(d)});a.setTitle(b),a.setPosition(e),a.setAnimation(google.maps.Animation.DROP)}function coordinateChange(){var a=document.getElementById('map_latitude').value,b=document.getElementById('map_longitude').value;if(''!=a&&''!=b){const c=new google.maps.LatLng({lat:parseFloat(a),lng:parseFloat(b)});marker.setPosition(c)}}function getLatLng(a){var b=[document.getElementById('country').value.trim(),document.getElementById('city').value.trim(),document.getElementById('address').value.trim()];b=b.join('+');const c='https://maps.googleapis.com/maps/api/geocode/json?address='+b+'&key='+a;var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){const a=JSON.parse(d.responseText);if(!a)return void alert('Wrong JSON format!');if('OK'!=a.status)return void alert('Position identification failed.\nStatus code: '+a.status+'\nStatus message: '+a.error_message);const b=a.results[0].geometry.location;document.getElementById('map_latitude').value=b.lat,document.getElementById('map_longitude').value=b.lng,mapResize()}},d.open('GET',c,!0),d.send()}